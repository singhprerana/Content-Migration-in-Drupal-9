id: mh_partner_node_de
label: Partner node data import | German
migration_group: partner_node_import
source:
  plugin: url
  data_fetcher_plugin: file
  data_parser_plugin: json
  include_raw_data: true
  track_changes: true
  urls:
    - 'sites/default/files/migration-source/partner.json'
  item_selector: items/
  # Field Selectors
  fields:
    - name: title
      label: 'title'
      selector: fields/title/de

    - name: description
      label: 'description'
      selector: fields/description/de
    
    - name: partnerType
      label: 'Partner Type'
      selector: fields/partnerType/en-US

    - name: partnerLevel
      label: 'Partner Level'
      selector: fields/partnerLevel/en-US/0/name

    # - name: partnerLevel_de
    #   label: 'Partner Level'
    #   selector: fields/partnerLevel/de/0/name

    - name: createdAt
      label: 'createdAt'
      selector: sys/createdAt

    - name: updatedAt
      label: 'updatedAt'
      selector: sys/updatedAt

    - name: id
      label: 'id'
      selector: sys/id

    - name: imageId
      label: 'imageId'
      selector: fields/image/en-US/sys/id

    - name: pageUrl
      label: 'URL alias'
      selector: fields/pageUrl/en-US

  ids:
    id:
      type: string
  # Constants used
  constants:
    UID: 1
# Data Mapping process
process:
  nid:
    plugin: migration_lookup
    source: id
    migration: mh_partner_node
  # Node Title
  title:
    plugin: skip_on_condition
    source: title
    condition:
      plugin: or
      conditions:
        -
          plugin: is_null
        -
          plugin: empty
    method: row
    message: 'German translation not available for this ID.'
  field_partner_description: description
  # Partner Level
  # field_partner_level:
  #   plugin: if_condition
  #   condition:
  #     plugin: empty
  #     negate: true
  #   source: partnerLevel_de
  #   do_process:
  #     plugin: entity_lookup
  #     source: partnerLevel_de
  #     langcode: de
  #     value_key: name
  #     bundle_key: vid
  #     bundle: partner_level
  #     entity_type: taxonomy_term
  #     ignore_case: true
  #   else_process:
  #     plugin: entity_lookup
  #     source: partnerLevel
  #     value_key: name
  #     bundle_key: vid
  #     bundle: partner_level
  #     entity_type: taxonomy_term
  #     ignore_case: true
  # Partner Type
  field_partner_level:
    plugin: entity_generate
    source: partnerLevel
    entity_type: taxonomy_term
    bundle_key: vid
    bundle: partner_level
    value_key: name
  field_partner_type:
    plugin: sub_process
    source: partnerType
    process:
      target_id:
        plugin: entity_lookup
        source: name
        entity_type: taxonomy_term
        bundle: partner_type
        bundle_key: vid
        value_key: name
        ignore_case: true
  # Source for Global Fields
  pseudo_paragraph:
    plugin: migration_lookup
    migration: mh_partner_node_paragraphs_de
    source: id
  # Global Fields
  field_paragraph_content:
    plugin: sub_process
    source:
      - '@pseudo_paragraph'
    process:
      target_id: '0'
      target_revision_id: '1'
  # Authored On
  created:
    plugin: format_date
    source: createdAt
    from_format: 'Y-m-d\TH:i:s.v\Z'
    to_format: U
    from_timezone: UTC
    to_timezone: UTC
  # Updated On
  changed:
    plugin: format_date
    source: updatedAt
    from_format: 'Y-m-d\TH:i:s.v\Z'
    to_format: U
    from_timezone: UTC
    to_timezone: UTC
  # URL Alias
  path/pathauto:
    plugin: if_condition
    source: pageUrl
    condition: empty
    do_get: constants/PATH_AUTO_TRUE
    else_get: constants/PATH_AUTO_FALSE
  path/alias: pageUrl
  # Node Language
  langcode:
    plugin: default_value
    default_value: de
  # Current Moderation State
  moderation_state: 
    plugin: default_value
    default_value: 'published'
  # Translation source
  content_translation_source:
    plugin: default_value
    default_value: en
  uid: constants/UID
# Bundle details
destination:
  plugin: 'entity:node'
  default_bundle: partner
  translations: true
migration_dependencies:
  required:
    - mh_partner_node
    - mh_partner_node_paragraphs_de
